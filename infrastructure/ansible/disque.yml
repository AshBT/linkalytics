- hosts: all
  tasks:
    - name: Create disque node groups
      group_by: key={{ ansible_hostname | regex_replace('-[\d]+', '')}}

- hosts: disque-*
  tasks:
    - name: Install git
      apt: pkg=git state=installed update_cache=true

    - name: Install build tools
      apt: pkg=build-essential state=installed update_cache=true

    - name: Clone disque source
      git: repo=https://github.com/antirez/disque.git dest=/home/ansible/disque

    - name: Build and install disque
      command: make install chdir=/home/ansible/disque

    - name: Install supervisord
      apt: pkg=supervisor state=installed update_cache=true

    - name: Synchronize supervisor configuration
      synchronize: src=disque.conf dest=/etc/supervisor/conf.d/disque.conf
      notify:
        - Restart disque

    - name: Enable supervisord
      service: name=supervisor enabled=yes

    - name: Start supervisord
      service: name=supervisor state=started

  handlers:
    - name: Restart disque
      service: name=supervisor state=restarted

- hosts: disque-0
  tasks:
    - name: Configure disque cluster meets
      command: disque cluster meet {{ hostvars[item].ansible_eth0.ipv4.address }} 7711
      with_items: "{{ groups.disque }}"
      when: "'disque' in item and item != 'disque-0'"
